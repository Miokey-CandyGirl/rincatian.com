<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¡µé¢è°ƒè¯•å·¥å…· - ç³å‡¯è’‚äºšè¯­ç¤¾åŒº</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a237e; color: white; }
        .debug-panel { background: rgba(255,255,255,0.1); padding: 20px; margin: 20px 0; border-radius: 10px; border: 1px solid rgba(255,215,0,0.3); }
        .debug-button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .debug-button:hover { background: #45a049; }
        .debug-output { background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: rgba(76,175,80,0.2); color: #4caf50; }
        .error { background: rgba(244,67,54,0.2); color: #f44336; }
        .warning { background: rgba(255,152,0,0.2); color: #ff9800; }
        .info { background: rgba(33,150,243,0.2); color: #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç®¡ç†é¡µé¢è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-panel">
        <h2>ğŸ” å¿«é€Ÿè¯Šæ–­</h2>
        <button class="debug-button" onclick="quickDiagnosis()">å¿«é€Ÿè¯Šæ–­é—®é¢˜</button>
        <button class="debug-button" onclick="checkUserState()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
        <button class="debug-button" onclick="checkPageElements()">æ£€æŸ¥é¡µé¢å…ƒç´ </button>
        <button class="debug-button" onclick="forceShowAdmin()">å¼ºåˆ¶æ˜¾ç¤ºç®¡ç†é¢æ¿</button>
        <div id="diagnosisResult" class="status info">ç­‰å¾…è¯Šæ–­...</div>
    </div>
    
    <div class="debug-panel">
        <h2>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€è®¾ç½®</h2>
        <button class="debug-button" onclick="setAdminUser()">è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·</button>
        <button class="debug-button" onclick="clearUserData()">æ¸…é™¤ç”¨æˆ·æ•°æ®</button>
        <button class="debug-button" onclick="checkAuthSystems()">æ£€æŸ¥è®¤è¯ç³»ç»Ÿ</button>
        <div id="userStatus" class="status info">ç­‰å¾…æ“ä½œ...</div>
    </div>
    
    <div class="debug-panel">
        <h2>ğŸ› ï¸ ä¿®å¤æ“ä½œ</h2>
        <button class="debug-button" onclick="fixAdminAccess()">ä¿®å¤ç®¡ç†å‘˜æƒé™</button>
        <button class="debug-button" onclick="reloadAdminPanel()">é‡æ–°åŠ è½½ç®¡ç†é¢æ¿</button>
        <button class="debug-button" onclick="resetAdminPage()">é‡ç½®ç®¡ç†é¡µé¢</button>
        <div id="fixStatus" class="status info">ç­‰å¾…ä¿®å¤...</div>
    </div>
    
    <div class="debug-panel">
        <h2>ğŸ“Š è°ƒè¯•è¾“å‡º</h2>
        <div class="debug-output" id="debugOutput">[ç³»ç»Ÿ] è°ƒè¯•å·¥å…·å·²å¯åŠ¨<br></div>
        <button class="debug-button" onclick="clearDebugOutput()">æ¸…ç©ºè¾“å‡º</button>
        <button class="debug-button" onclick="openAdminPage()">æ‰“å¼€ç®¡ç†é¡µé¢</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = { 'success': '#00ff00', 'error': '#ff0000', 'warning': '#ffaa00', 'info': '#00ffff' };
            const color = colors[type] || '#ffffff';
            const outputElement = document.getElementById('debugOutput');
            outputElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        
        function quickDiagnosis() {
            log('å¼€å§‹å¿«é€Ÿè¯Šæ–­...', 'info');
            
            // æ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·æ•°æ®
            const currentUser = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');
            const adminToken = localStorage.getItem('adminToken');
            
            log('å½“å‰ç”¨æˆ·æ•°æ®: ' + (currentUser || 'æ— '), currentUser ? 'success' : 'warning');
            log('è®¤è¯ä»¤ç‰Œ: ' + (authToken || 'æ— '), authToken ? 'success' : 'warning');
            log('ç®¡ç†å‘˜ä»¤ç‰Œ: ' + (adminToken || 'æ— '), adminToken ? 'success' : 'warning');
            
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    log(`ç”¨æˆ·å: ${user.username}, è§’è‰²: ${user.role}`, 'info');
                    
                    if (user.username === 'admin' || user.role === 'admin') {
                        log('âœ… æ£€æµ‹åˆ°ç®¡ç†å‘˜ç”¨æˆ·', 'success');
                        document.getElementById('diagnosisResult').innerHTML = 'âœ… æ£€æµ‹åˆ°ç®¡ç†å‘˜ç”¨æˆ·ï¼Œé—®é¢˜å¯èƒ½åœ¨é¡µé¢æ˜¾ç¤º';
                        document.getElementById('diagnosisResult').className = 'status success';
                    } else {
                        log('âŒ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜', 'error');
                        document.getElementById('diagnosisResult').innerHTML = 'âŒ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜';
                        document.getElementById('diagnosisResult').className = 'status error';
                    }
                } catch (error) {
                    log('âŒ ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯: ' + error.message, 'error');
                    document.getElementById('diagnosisResult').innerHTML = 'âŒ ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯';
                    document.getElementById('diagnosisResult').className = 'status error';
                }
            } else {
                log('âŒ æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®', 'error');
                document.getElementById('diagnosisResult').innerHTML = 'âŒ æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œéœ€è¦å…ˆç™»å½•';
                document.getElementById('diagnosisResult').className = 'status error';
            }
        }
        
        function checkUserState() {
            log('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ç”¨æˆ·æ•°æ®æº
            const sources = [
                { name: 'localStorage.currentUser', data: localStorage.getItem('currentUser') },
                { name: 'localStorage.authToken', data: localStorage.getItem('authToken') },
                { name: 'window.authSystem', data: window.authSystem },
                { name: 'window.communitySystem', data: window.communitySystem }
            ];
            
            sources.forEach(source => {
                if (source.data) {
                    if (typeof source.data === 'string') {
                        log(`${source.name}: ${source.data}`, 'success');
                    } else {
                        log(`${source.name}: å¯¹è±¡å­˜åœ¨`, 'success');
                        if (source.data.currentUser) {
                            log(`  - currentUser: ${JSON.stringify(source.data.currentUser)}`, 'info');
                        }
                    }
                } else {
                    log(`${source.name}: ä¸å­˜åœ¨`, 'warning');
                }
            });
            
            document.getElementById('userStatus').innerHTML = 'ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆï¼ŒæŸ¥çœ‹è°ƒè¯•è¾“å‡º';
            document.getElementById('userStatus').className = 'status info';
        }
        
        function checkPageElements() {
            log('æ£€æŸ¥é¡µé¢å…ƒç´ ...', 'info');
            
            // æ£€æŸ¥å…³é”®å…ƒç´ 
            const elements = [
                'adminPanel',
                'accessDenied', 
                'userName',
                'userInfo',
                'authButtons'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const style = window.getComputedStyle(element);
                    log(`${id}: å­˜åœ¨, display: ${style.display}, visibility: ${style.visibility}`, 'success');
                } else {
                    log(`${id}: ä¸å­˜åœ¨`, 'error');
                }
            });
        }
        
        function setAdminUser() {
            log('è®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·...', 'info');
            
            const adminUser = {
                id: 'admin-debug',
                username: 'admin',
                role: 'admin',
                email: 'admin@rincatian.com',
                avatar: 'ğŸ‘‘',
                joinDate: Date.now(),
                lastLogin: Date.now()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(adminUser));
            localStorage.setItem('adminToken', 'true');
            localStorage.setItem('authToken', 'admin-token-' + Date.now());
            
            log('âœ… ç®¡ç†å‘˜ç”¨æˆ·è®¾ç½®å®Œæˆ', 'success');
            document.getElementById('userStatus').innerHTML = 'âœ… ç®¡ç†å‘˜ç”¨æˆ·è®¾ç½®å®Œæˆ';
            document.getElementById('userStatus').className = 'status success';
        }
        
        function clearUserData() {
            log('æ¸…é™¤ç”¨æˆ·æ•°æ®...', 'info');
            
            const keys = ['currentUser', 'authToken', 'adminToken', 'isAdmin'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                log(`æ¸…é™¤: ${key}`, 'info');
            });
            
            log('âœ… ç”¨æˆ·æ•°æ®æ¸…é™¤å®Œæˆ', 'success');
            document.getElementById('userStatus').innerHTML = 'âœ… ç”¨æˆ·æ•°æ®æ¸…é™¤å®Œæˆ';
            document.getElementById('userStatus').className = 'status success';
        }
        
        function checkAuthSystems() {
            log('æ£€æŸ¥è®¤è¯ç³»ç»Ÿ...', 'info');
            
            if (window.authSystem) {
                log('âœ… window.authSystem å­˜åœ¨', 'success');
                log(`currentUser: ${JSON.stringify(window.authSystem.currentUser)}`, 'info');
            } else {
                log('âŒ window.authSystem ä¸å­˜åœ¨', 'error');
            }
            
            if (window.communitySystem) {
                log('âœ… window.communitySystem å­˜åœ¨', 'success');
                log(`currentUser: ${JSON.stringify(window.communitySystem.currentUser)}`, 'info');
            } else {
                log('âŒ window.communitySystem ä¸å­˜åœ¨', 'error');
            }
        }
        
        function forceShowAdmin() {
            log('å¼ºåˆ¶æ˜¾ç¤ºç®¡ç†é¢æ¿...', 'info');
            
            // é¦–å…ˆè®¾ç½®ç®¡ç†å‘˜ç”¨æˆ·
            setAdminUser();
            
            // ç„¶åå¼ºåˆ¶æ˜¾ç¤ºé¢æ¿
            setTimeout(() => {
                log('å‘ç®¡ç†é¡µé¢å‘é€å¼ºåˆ¶æ˜¾ç¤ºå‘½ä»¤...', 'info');
                
                // è®¾ç½®å¼ºåˆ¶æ˜¾ç¤ºæ ‡å¿—
                localStorage.setItem('forceShowAdmin', 'true');
                localStorage.setItem('adminForceTimestamp', Date.now().toString());
                
                // è®¾ç½®ç®¡ç†å‘˜ä»¤ç‰Œ
                localStorage.setItem('adminToken', 'true');
                
                // è§¦å‘ storage äº‹ä»¶ï¼ˆå¦‚æœç®¡ç†é¡µé¢åœ¨åŒä¸€ä¸ªæ ‡ç­¾é¡µä¸­ï¼‰
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'forceShowAdmin',
                    newValue: 'true',
                    oldValue: null,
                    storageArea: localStorage
                }));
                
                log('âœ… å¼ºåˆ¶æ˜¾ç¤ºå‘½ä»¤å·²å‘é€', 'success');
                log('ğŸ”„ è¯·åˆ·æ–°ç®¡ç†é¡µé¢æˆ–ç‚¹å‡»â€œå¼ºåˆ¶æ˜¾ç¤ºâ€æŒ‰é’®', 'warning');
                
                document.getElementById('diagnosisResult').innerHTML = 'âœ… å¼ºåˆ¶æ˜¾ç¤ºå‘½ä»¤å·²å‘é€ï¼Œè¯·åˆ·æ–°ç®¡ç†é¡µé¢';
                document.getElementById('diagnosisResult').className = 'status success';
                
                // è‡ªåŠ¨æ‰“å¼€ç®¡ç†é¡µé¢
                setTimeout(() => {
                    openAdminPage();
                }, 1000);
            }, 500);
        }
        
        function fixAdminAccess() {
            log('ä¿®å¤ç®¡ç†å‘˜æƒé™...', 'info');
            
            // 1. è®¾ç½®æ­£ç¡®çš„ç”¨æˆ·æ•°æ®
            setAdminUser();
            
            // 2. è®¾ç½®å¼ºåˆ¶æ˜¾ç¤ºæ ‡å¿—
            localStorage.setItem('forceShowAdmin', 'true');
            localStorage.setItem('adminDebugMode', 'true');
            
            // 3. åˆ›å»ºå®Œæ•´çš„ç”¨æˆ·æ•°æ®
            const users = [
                {
                    id: 'admin-001',
                    username: 'admin',
                    email: 'admin@rincatian.com',
                    role: 'admin',
                    status: 'active',
                    joinDate: Date.now() - 86400000 * 30,
                    lastLogin: Date.now(),
                    avatar: 'ğŸ‘‘'
                }
            ];
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('linkaitiya_users', JSON.stringify(users));
            
            log('âœ… ç®¡ç†å‘˜æƒé™ä¿®å¤å®Œæˆ', 'success');
            document.getElementById('fixStatus').innerHTML = 'âœ… ç®¡ç†å‘˜æƒé™ä¿®å¤å®Œæˆï¼Œè¯·åˆ·æ–°ç®¡ç†é¡µé¢';
            document.getElementById('fixStatus').className = 'status success';
        }
        
        function reloadAdminPanel() {
            log('é‡æ–°åŠ è½½ç®¡ç†é¢æ¿...', 'info');
            
            if (window.opener && window.opener.adminPanel) {
                try {
                    window.opener.adminPanel.forceAdminCheck();
                    window.opener.adminPanel.checkAdminAccess();
                    log('âœ… ç®¡ç†é¢æ¿é‡æ–°åŠ è½½å®Œæˆ', 'success');
                } catch (error) {
                    log('âŒ é‡æ–°åŠ è½½å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                log('âŒ æ— æ³•è®¿é—®ç®¡ç†é¢æ¿', 'error');
            }
        }
        
        function resetAdminPage() {
            log('é‡ç½®ç®¡ç†é¡µé¢...', 'info');
            
            // æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
            clearUserData();
            
            // é‡æ–°è®¾ç½®ç®¡ç†å‘˜
            setTimeout(() => {
                fixAdminAccess();
                log('âœ… ç®¡ç†é¡µé¢é‡ç½®å®Œæˆ', 'success');
                document.getElementById('fixStatus').innerHTML = 'âœ… ç®¡ç†é¡µé¢é‡ç½®å®Œæˆ';
                document.getElementById('fixStatus').className = 'status success';
            }, 500);
        }
        
        function clearDebugOutput() {
            document.getElementById('debugOutput').innerHTML = '';
            log('è°ƒè¯•è¾“å‡ºå·²æ¸…ç©º', 'info');
        }
        
        function openAdminPage() {
            window.open('admin.html', '_blank');
            log('å·²æ‰“å¼€ç®¡ç†é¡µé¢', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        document.addEventListener('DOMContentLoaded', function() {
            log('è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'info');
            setTimeout(quickDiagnosis, 1000);
        });
        
        // ç›‘å¬localStorageå˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key && (e.key.includes('admin') || e.key.includes('user') || e.key.includes('auth'))) {
                log(`æ£€æµ‹åˆ°å­˜å‚¨å˜åŒ–: ${e.key} = ${e.newValue}`, 'info');
            }
        });
    </script>
</body>
</html>