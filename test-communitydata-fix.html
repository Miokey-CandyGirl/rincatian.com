<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommunityDataä¿®å¤æµ‹è¯• - ç³å‡¯è’‚äºšè¯­</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="community.css">
    <style>
        .test-container {
            max-width: 900px;
            margin: 120px auto 0;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.8));
            border-radius: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .test-title {
            text-align: center;
            color: #ffd700;
            font-size: 2rem;
            margin-bottom: 2rem;
        }
        
        .test-button {
            display: inline-block;
            margin: 0.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(45deg, #ffd700, #4ecdc4);
            color: #1a1a2e;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border-left: 4px solid #4ecdc4;
        }
        
        .log-container {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            margin: 0.5rem 0;
            padding: 0.75rem;
            border-left: 3px solid #4ecdc4;
            background: rgba(255, 255, 255, 0.05);
            font-family: monospace;
            font-size: 0.9rem;
            border-radius: 5px;
        }
        
        .log-success { border-left-color: #00b894; color: #00b894; }
        .log-error { border-left-color: #e74c3c; color: #e74c3c; }
        .log-warning { border-left-color: #f39c12; color: #f39c12; }
        .log-info { border-left-color: #3498db; color: #3498db; }
        
        .fix-highlights {
            background: linear-gradient(45deg, rgba(0, 184, 148, 0.1), rgba(116, 185, 255, 0.1));
            border: 1px solid rgba(0, 184, 148, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <div class="planet-icon"></div>
                <div class="logo-text">
                    <span class="logo-chinese">CommunityDataä¿®å¤</span>
                    <span class="logo-english">Fix Test</span>
                </div>
            </div>
            <div class="nav-extras">
                <div class="auth-buttons">
                    <button class="btn btn-outline btn-small">ç™»å½•</button>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-name" id="userName"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="test-container">
        <h1 class="test-title">ğŸ”§ CommunityData æœªå®šä¹‰ä¿®å¤æµ‹è¯•</h1>
        
        <div class="fix-highlights">
            <h3 style="color: #ffd700; margin-bottom: 1rem;">ğŸ¯ ä¿®å¤å†…å®¹</h3>
            <ul style="color: #e0e0e0; line-height: 1.8;">
                <li><strong>ğŸ›¡ï¸ å…¼å®¹å±‚åˆå§‹åŒ–</strong>ï¼šåˆ›å»ºå…¨å±€ communityData å¯¹è±¡ï¼Œç¡®ä¿ç«‹å³å¯ç”¨</li>
                <li><strong>ğŸ“Š æ•°æ®åŒæ­¥æœºåˆ¶</strong>ï¼šæ–°æ—§ç³»ç»Ÿä¹‹é—´çš„æ•°æ®åŒæ­¥å’Œå…¼å®¹</li>
                <li><strong>ğŸ” é”™è¯¯æ£€æµ‹å¢å¼º</strong>ï¼šåœ¨å‘å¸ƒå‡½æ•°ä¸­æ·»åŠ è¯¦ç»†çš„é”™è¯¯è¯Šæ–­</li>
                <li><strong>ğŸ’¾ æœ¬åœ°å­˜å‚¨ä¿æŠ¤</strong>ï¼šç¡®ä¿æ•°æ®æŒä¹…åŒ–å’Œæ¢å¤æœºåˆ¶</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <button class="test-button" onclick="checkCommunityData()">ğŸ” æ£€æŸ¥ CommunityData</button>
            <button class="test-button" onclick="quickLogin()">âš¡ å¿«é€Ÿç™»å½•</button>
            <button class="test-button" onclick="testPostModal()">ğŸ“ æµ‹è¯•å‘å¸ƒ</button>
            <button class="test-button" onclick="testDisplayFix()">ğŸ”„ æµ‹è¯•æ˜¾ç¤ºä¿®å¤</button>
            <button class="test-button" onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="log-container">
            <h4 style="color: #ffd700; margin-bottom: 1rem;">ğŸ“‹ å®æ—¶æµ‹è¯•æ—¥å¿—</h4>
            <div id="testLog"></div>
        </div>
    </div>

    <script src="auth-system.js"></script>
    <script src="community-system.js"></script>
    <script src="content-manager.js"></script>
    <script src="script.js"></script>
    <script src="community.js"></script>

    <script>
        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            const icon = icons[type] || icons.info;
            
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.innerHTML = `[${timestamp}] ${icon} ${message}`;
            
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[æµ‹è¯•] ${message}`);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸŒŸ CommunityDataä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info');
            setTimeout(() => {
                checkCommunityData();
            }, 1000);
        });

        // æ£€æŸ¥ CommunityData
        function checkCommunityData() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥ CommunityData...', 'info');
            
            try {
                if (typeof communityData === 'undefined') {
                    log('âŒ communityData æœªå®šä¹‰ï¼è¿™æ˜¯å¯¼è‡´é”™è¯¯çš„æ ¹æœ¬åŸå› ', 'error');
                    
                    // å°è¯•æ‰‹åŠ¨åˆå§‹åŒ–
                    if (typeof ensureCompatibilityLayer === 'function') {
                        ensureCompatibilityLayer();
                        log('âœ… æ‰‹åŠ¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                    } else {
                        log('âŒ ensureCompatibilityLayer å‡½æ•°ä¸å­˜åœ¨', 'error');
                    }
                } else {
                    log('âœ… communityData å·²å®šä¹‰', 'success');
                    log(`ğŸ“Š ç”¨æˆ·æ•°é‡: ${communityData.users.length}`, 'info');
                    log(`ğŸ“„ å¸–å­æ•°é‡: ${communityData.posts.length}`, 'info');
                    log(`ğŸ‘¤ å½“å‰ç”¨æˆ·: ${communityData.currentUser ? communityData.currentUser.username : 'æœªç™»å½•'}`, 'info');
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // å¿«é€Ÿç™»å½•
        async function quickLogin() {
            log('âš¡ æ‰§è¡Œå¿«é€Ÿç™»å½•...', 'info');
            
            try {
                if (!window.authSystem) {
                    log('âŒ è®¤è¯ç³»ç»ŸæœªåŠ è½½', 'error');
                    return;
                }
                
                const result = await window.authSystem.login({
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (result.success) {
                    log(`âœ… ç™»å½•æˆåŠŸ: ${window.authSystem.currentUser.username}`, 'success');
                    
                    // åŒæ­¥ç”¨æˆ·æ•°æ®åˆ°å…¼å®¹å±‚
                    if (typeof communityData !== 'undefined') {
                        const currentUser = window.authSystem.currentUser;
                        communityData.currentUser = {
                            id: currentUser.id,
                            username: currentUser.username,
                            email: currentUser.email || currentUser.username + '@linkaitiya.star',
                            userType: currentUser.userType || 'learner',
                            joinDate: currentUser.joinDate || Date.now(),
                            points: currentUser.points || 0,
                            rank: currentUser.rank || 'å…‰çº¿ä½¿è€…',
                            avatar: currentUser.avatar || currentUser.username.charAt(0).toUpperCase()
                        };
                        log('âœ… ç”¨æˆ·æ•°æ®å·²åŒæ­¥åˆ°å…¼å®¹å±‚', 'success');
                    }
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å‘å¸ƒæ¨¡æ€æ¡†
        function testPostModal() {
            log('ğŸ“ æµ‹è¯•å‘å¸ƒæ¨¡æ€æ¡†å’Œæäº¤åŠŸèƒ½...', 'info');
            
            try {
                if (!window.authSystem?.currentUser) {
                    log('âš ï¸ è¯·å…ˆç™»å½•å†æµ‹è¯•å‘å¸ƒåŠŸèƒ½', 'warning');
                    return;
                }
                
                if (typeof showNewPostModal === 'function') {
                    log('ğŸ­ æ‰“å¼€å‘å¸ƒæ¨¡æ€æ¡†...', 'info');
                    showNewPostModal();
                    
                    // è‡ªåŠ¨å¡«å†™å¹¶æäº¤æµ‹è¯•
                    setTimeout(() => {
                        const titleInput = document.getElementById('newPostTitle');
                        const contentInput = document.getElementById('newPostContent');
                        
                        if (titleInput && contentInput) {
                            titleInput.value = 'æµ‹è¯•æ ‡é¢˜ - CommunityDataä¿®å¤éªŒè¯';
                            contentInput.value = 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•å†…å®¹ï¼Œç”¨äºéªŒè¯ communityData æœªå®šä¹‰é”™è¯¯çš„ä¿®å¤æ•ˆæœã€‚å¦‚æœæ‚¨çœ‹åˆ°è¿™ä¸ªå¸–å­ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼';
                            
                            log('âœ… å·²è‡ªåŠ¨å¡«å†™è¡¨å•å†…å®¹', 'success');
                            log('ğŸ“¤ æ­£åœ¨æµ‹è¯•æäº¤åŠŸèƒ½...', 'info');
                            
                            // æµ‹è¯•æäº¤
                            if (typeof handleNewPostSubmit === 'function') {
                                handleNewPostSubmit();
                                log('âœ… æäº¤å‡½æ•°å·²è°ƒç”¨ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦ç»†ä¿¡æ¯', 'success');
                            } else {
                                log('âŒ handleNewPostSubmit å‡½æ•°ä¸å­˜åœ¨', 'error');
                            }
                            
                        } else {
                            log('âŒ æœªæ‰¾åˆ°è¡¨å•å…ƒç´ ', 'error');
                        }
                    }, 500);
                } else {
                    log('âŒ showNewPostModal å‡½æ•°ä¸å­˜åœ¨', 'error');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
            }
        }

        // æµ‹è¯•æ˜¾ç¤ºä¿®å¤
        function testDisplayFix() {
            log('ğŸ”„ æµ‹è¯•è®¨è®ºåˆ—è¡¨æ˜¾ç¤ºä¿®å¤...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¸–å­æ•°æ®
                const localPosts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
                log(`ğŸ’¾ æœ¬åœ°å­˜å‚¨ä¸­æœ‰ ${localPosts.length} ä¸ªå¸–å­`, 'info');
                
                if (localPosts.length === 0) {
                    log('âš ï¸ æ²¡æœ‰å¸–å­æ•°æ®ï¼Œå°†åˆ›å»ºæµ‹è¯•æ•°æ®', 'warning');
                    
                    // åˆ›å»ºæµ‹è¯•å¸–å­
                    const testPosts = [
                        {
                            id: 'test_' + Date.now(),
                            title: 'ğŸ† æµ‹è¯•å¸–å­ - æ˜¾ç¤ºä¿®å¤éªŒè¯',
                            content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¸–å­ï¼Œç”¨äºéªŒè¯å¸–å­åœ¨è®¨è®ºå¹¿åœºä¸­çš„æ˜¾ç¤ºåŠŸèƒ½ã€‚å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™ä¸ªå¸–å­ï¼Œè¯´æ˜æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸ï¼',
                            category: 'general',
                            tags: ['æµ‹è¯•', 'ä¿®å¤', 'æ˜¾ç¤º'],
                            author: {
                                id: 'test_user',
                                username: 'æµ‹è¯•ç”¨æˆ·',
                                displayName: 'æµ‹è¯•ç”¨æˆ·',
                                avatar: 'ğŸ§ª'
                            },
                            timestamp: Date.now() - 60000, // 1åˆ†é’Ÿå‰
                            likes: [],
                            replyCount: 0,
                            views: 0,
                            status: 'active',
                            timeDisplay: '1åˆ†é’Ÿå‰'
                        },
                        {
                            id: 'test2_' + Date.now(),
                            title: 'ğŸŒŒ æ¬¢è¿æ¥åˆ°ç³å‡¯è’‚äºšè¯­ç¤¾åŒº',
                            content: 'å¤§å®¶å¥½ï¼æ¬¢è¿æ¥åˆ°ç³å‡¯è’‚äºšè¯­å­¦ä¹ ç¤¾åŒºã€‚è¿™é‡Œæ˜¯å…‰çº¿ä½¿è€…ä»¬äº¤æµå­¦ä¹ çš„åœ°æ–¹ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªç¥ç§˜çš„å®‡å®™è¯­è¨€ï¼',
                            category: 'culture',
                            tags: ['æ¬¢è¿', 'ç¤¾åŒº', 'å­¦ä¹ '],
                            author: {
                                id: 'admin',
                                username: 'admin',
                                displayName: 'ç®¡ç†å‘˜',
                                avatar: 'ğŸŒŸ'
                            },
                            timestamp: Date.now() - 300000, // 5åˆ†é’Ÿå‰
                            likes: ['user1', 'user2'],
                            replyCount: 3,
                            views: 25,
                            status: 'active',
                            timeDisplay: '5åˆ†é’Ÿå‰'
                        }
                    ];
                    
                    localStorage.setItem('communityPosts', JSON.stringify(testPosts));
                    log('âœ… æµ‹è¯•å¸–å­æ•°æ®å·²åˆ›å»º', 'success');
                }
                
                // æ£€æŸ¥ loadDiscussions å‡½æ•°
                if (typeof loadDiscussions === 'function') {
                    log('ğŸ”„ æ­£åœ¨åˆ·æ–°è®¨è®ºåˆ—è¡¨...', 'info');
                    loadDiscussions();
                    log('âœ… è®¨è®ºåˆ—è¡¨åˆ·æ–°å®Œæˆ', 'success');
                } else {
                    log('âŒ loadDiscussions å‡½æ•°ä¸å­˜åœ¨', 'error');
                }
                
                // æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰ postsList å…ƒç´ 
                const postsList = document.getElementById('postsList');
                if (postsList) {
                    log('âœ… æ‰¾åˆ° postsList å…ƒç´ ', 'success');
                    log(`ğŸ“Š å½“å‰æ˜¾ç¤ºçš„å¸–å­æ•°é‡: ${postsList.children.length}`, 'info');
                } else {
                    log('âŒ æœªæ‰¾åˆ° postsList å…ƒç´ ï¼Œè¯·ç¡®ä¿åœ¨æ­£ç¡®çš„é¡µé¢ä¸Šæµ‹è¯•', 'error');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•æ˜¾ç¤ºä¿®å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
    </script>
</body>
</html>