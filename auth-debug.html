<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯ç³»ç»Ÿè¯Šæ–­ - ç³å‡¯è’‚äºšè¯­ç¤¾åŒº</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .status-good { border-color: #4caf50; }
        .status-warning { border-color: #ff9800; }
        .status-error { border-color: #f44336; }
        
        .btn {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è®¤è¯ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­ç™»å½•å¤±è´¥é—®é¢˜</p>
        
        <div id="statusContainer">
            <div class="status-item status-warning">
                <strong>â³ æ­£åœ¨æ£€æŸ¥...</strong><br>
                ç³»ç»Ÿè¯Šæ–­è¿›è¡Œä¸­...
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="runFullDiagnosis()">ğŸ” å®Œæ•´è¯Šæ–­</button>
            <button class="btn" onclick="tryFixAuth()">ğŸ”§ å°è¯•ä¿®å¤</button>
            <button class="btn" onclick="testLogin()">ğŸ§ª æµ‹è¯•ç™»å½•</button>
            <button class="btn" onclick="initializeDatabase()">ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“</button>
            <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
        </div>

        <div class="log-container" id="logContainer">
            <div style="color: #4caf50;">[INFO] è¯Šæ–­å·¥å…·å·²å¯åŠ¨</div>
        </div>

        <div style="margin-top: 20px;">
            <h3>ğŸ“‹ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ</h3>
            
            <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>ğŸ”¥ æœ€å¸¸è§é—®é¢˜ï¼šæ•°æ®åº“è¡¨æœªåˆå§‹åŒ–</h4>
                <p><strong>å¦‚æœæ˜¾ç¤ºâ€œè¡¨ä¸å­˜åœ¨â€é”™è¯¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</strong></p>
                <ol>
                    <li>ç™»å½• <a href="https://supabase.com/dashboard" target="_blank" style="color: #ffd700;">ğŸ”— Supabase æ§åˆ¶å°</a></li>
                    <li>è¿›å…¥æ‚¨çš„é¡¹ç›® â†’ SQL Editor</li>
                    <li>å¤åˆ¶ <code>supabase-database-setup.sql</code> ä¸­çš„å…¨éƒ¨å†…å®¹</li>
                    <li>ç²˜è´´åˆ° SQL ç¼–è¾‘å™¨å¹¶æ‰§è¡Œ</li>
                    <li>è¿”å›æ­¤é¡µé¢ç‚¹å‡» â€œğŸ“Š åˆå§‹åŒ–æ•°æ®åº“â€ éªŒè¯</li>
                </ol>
            </div>
            
            <div style="background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>ğŸš« ç½‘ç»œè¿æ¥é—®é¢˜</h4>
                <p><strong>å¦‚æœæ˜¾ç¤ºç½‘ç»œè¿æ¥å¤±è´¥ï¼š</strong></p>
                <ol>
                    <li>ğŸš« æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å°é” <code>supabase.co</code></li>
                    <li>ğŸš« å…³é—­å¹¿å‘Šæ‹¦æˆªå™¨æˆ–è€…æµè§ˆå™¨æ‰©å±•</li>
                    <li>ğŸŒ å°è¯•ä½¿ç”¨ VPN æˆ–è€…æ›´æ¢ç½‘ç»œ</li>
                    <li>ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•</li>
                </ol>
            </div>
            
            <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>âœ… åŸºæœ¬æ’é”™æ­¥éª¤</h4>
                <ol>
                    <li><strong>åˆ·æ–°é¡µé¢</strong> - æŒ‰ F5 æˆ– Ctrl+R</li>
                    <li><strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong> - æŒ‰ Ctrl+Shift+Delete</li>
                    <li><strong>æ£€æŸ¥ç½‘ç»œè¿æ¥</strong> - ç¡®ä¿å¯ä»¥è®¿é—® Supabase</li>
                    <li><strong>ç¦ç”¨æµè§ˆå™¨æ‰©å±•</strong> - ä¸´æ—¶ç¦ç”¨å¹¿å‘Šæ‹¦æˆªå™¨</li>
                    <li><strong>ä½¿ç”¨ç°ä»£æµè§ˆå™¨</strong> - Chrome, Firefox, Edge</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Supabase CDNæ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabaseé…ç½® -->
    <script src="config/supabase.js"></script>
    <!-- GitHub Pageså…¼å®¹çš„è®¤è¯å’Œå†…å®¹ç®¡ç†ç³»ç»Ÿ -->
    <script src="github-pages-auth-system.js"></script>
    <script src="github-pages-content-manager-optimized.js"></script>

    <script>
        let diagnosticLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp} [${type.toUpperCase()}] ${message}`;
            diagnosticLogs.push(logEntry);
            
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.style.color = type === 'error' ? '#f44336' : 
                               type === 'warning' ? '#ff9800' : 
                               type === 'success' ? '#4caf50' : '#ffffff';
            logDiv.textContent = logEntry;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(items) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = items.map(item => `
                <div class="status-item status-${item.status}">
                    <strong>${item.icon} ${item.title}</strong><br>
                    ${item.description}
                </div>
            `).join('');
        }

        async function runFullDiagnosis() {
            log('å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            const results = [];

            // 1. æ£€æŸ¥ Supabase CDN
            if (typeof window.supabase !== 'undefined') {
                results.push({
                    icon: 'âœ…',
                    title: 'Supabase CDN å·²åŠ è½½',
                    description: 'Supabase JavaScript åº“åŠ è½½æˆåŠŸ',
                    status: 'good'
                });
                log('Supabase CDN æ£€æŸ¥é€šè¿‡', 'success');
            } else {
                results.push({
                    icon: 'âŒ',
                    title: 'Supabase CDN æœªåŠ è½½',
                    description: 'Supabase JavaScript åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
                    status: 'error'
                });
                log('Supabase CDN åŠ è½½å¤±è´¥', 'error');
            }

            // 2. æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
            if (window.supabaseClient) {
                results.push({
                    icon: 'âœ…',
                    title: 'Supabase å®¢æˆ·ç«¯å·²åˆ›å»º',
                    description: 'Supabase å®¢æˆ·ç«¯å®ä¾‹åˆ›å»ºæˆåŠŸ',
                    status: 'good'
                });
                log('Supabase å®¢æˆ·ç«¯æ£€æŸ¥é€šè¿‡', 'success');
                
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                try {
                    log('å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
                    
                    // é¦–å…ˆæµ‹è¯•ç®€å•çš„è¿æ¥
                    const { data, error } = await window.supabaseClient
                        .from('users')
                        .select('count', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (!error) {
                        results.push({
                            icon: 'âœ…',
                            title: 'æ•°æ®åº“è¿æ¥æ­£å¸¸',
                            description: `æˆåŠŸè¿æ¥åˆ° Supabase æ•°æ®åº“ï¼Œç”¨æˆ·è¡¨è®°å½•æ•°: ${data || 'unknown'}`,
                            status: 'good'
                        });
                        log('æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡', 'success');
                    } else {
                        throw error;
                    }
                } catch (error) {
                    log(`è¯¦ç»†é”™è¯¯ä¿¡æ¯: ${JSON.stringify(error, null, 2)}`, 'error');
                    
                    let errorDescription = `æ•°æ®åº“è¿æ¥é”™è¯¯: ${error.message}`;
                    let suggestions = '';
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“å»ºè®®
                    if (error.message.includes('Failed to fetch')) {
                        errorDescription += ' (ç½‘ç»œè¿æ¥å¤±è´¥)';
                        suggestions = 'å»ºè®®: 1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) æ£€æŸ¥é˜²ç«å¢™è®¾ç½® 3) å°è¯•ä½¿ç”¨VPN';
                    } else if (error.message.includes('Invalid API key')) {
                        errorDescription += ' (APIå¯†é’¥æ— æ•ˆ)';
                        suggestions = 'å»ºè®®: æ£€æŸ¥ Supabase é¡¹ç›®é…ç½®å’Œ API å¯†é’¥';
                    } else if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        errorDescription += ' (æ•°æ®è¡¨ä¸å­˜åœ¨)';
                        suggestions = 'å»ºè®®: æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æ­£ç¡®åˆ›å»ºè¡¨ç»“æ„';
                    } else if (error.code === 'PGRST116') {
                        errorDescription += ' (è¡¨ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®)';
                        suggestions = 'å»ºè®®: 1) è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ 2) æ£€æŸ¥RLSç­–ç•¥è®¾ç½®';
                    }
                    
                    results.push({
                        icon: 'âŒ',
                        title: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
                        description: `${errorDescription}<br><small style="color: #ffeb3b;">${suggestions}</small>`,
                        status: 'error'
                    });
                    log(`æ•°æ®åº“è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                    
                    // å°è¯•æµ‹è¯•åŸºç¡€è¿æ¥
                    try {
                        log('å°è¯•æµ‹è¯•åŸºç¡€ Supabase è¿æ¥...', 'info');
                        const response = await fetch('https://fnnbtlfqjfgbifhhnuij.supabase.co/rest/v1/', {
                            method: 'GET',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubmJ0bGZxamZnYmlmaGhudWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzgzMzIsImV4cCI6MjA3MzQxNDMzMn0.3dayc8xJQsrr3MbWp4C30hcjpOMd0P7ro380F6iQX00'
                            }
                        });
                        
                        if (response.ok || response.status === 400) {
                            log('åŸºç¡€ HTTP è¿æ¥æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½æ˜¯è¡¨ç»“æ„ç›¸å…³', 'warning');
                            results.push({
                                icon: 'âš ï¸',
                                title: 'HTTPè¿æ¥æ­£å¸¸ï¼Œä½†è¡¨è®¿é—®å¤±è´¥',
                                description: 'ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œä½†å¯èƒ½éœ€è¦åˆå§‹åŒ–æ•°æ®åº“è¡¨',
                                status: 'warning'
                            });
                        } else {
                            log(`HTTPè¿æ¥ä¹Ÿå¤±è´¥: ${response.status}`, 'error');
                        }
                    } catch (fetchError) {
                        log(`åŸºç¡€è¿æ¥æµ‹è¯•å¤±è´¥: ${fetchError.message}`, 'error');
                        results.push({
                            icon: 'âŒ',
                            title: 'ç½‘ç»œè¿æ¥å®Œå…¨å¤±è´¥',
                            description: 'æ— æ³•è¿æ¥åˆ° Supabase æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
                            status: 'error'
                        });
                    }
                }
            } else {
                results.push({
                    icon: 'âŒ',
                    title: 'Supabase å®¢æˆ·ç«¯æœªåˆ›å»º',
                    description: 'Supabase å®¢æˆ·ç«¯å®ä¾‹åˆ›å»ºå¤±è´¥',
                    status: 'error'
                });
                log('Supabase å®¢æˆ·ç«¯æœªåˆ›å»º', 'error');
            }

            // 3. æ£€æŸ¥è®¤è¯ç³»ç»Ÿ
            if (window.authSystem) {
                results.push({
                    icon: 'âœ…',
                    title: 'è®¤è¯ç³»ç»Ÿå·²åŠ è½½',
                    description: 'GitHub Pages è®¤è¯ç³»ç»ŸåŠ è½½æˆåŠŸ',
                    status: 'good'
                });
                log('è®¤è¯ç³»ç»Ÿæ£€æŸ¥é€šè¿‡', 'success');

                // æ£€æŸ¥è®¤è¯æ–¹æ³•
                if (typeof window.authSystem.login === 'function') {
                    results.push({
                        icon: 'âœ…',
                        title: 'ç™»å½•æ–¹æ³•å¯ç”¨',
                        description: 'login() æ–¹æ³•å·²æ­£ç¡®å®šä¹‰',
                        status: 'good'
                    });
                    log('ç™»å½•æ–¹æ³•æ£€æŸ¥é€šè¿‡', 'success');
                } else {
                    results.push({
                        icon: 'âŒ',
                        title: 'ç™»å½•æ–¹æ³•ç¼ºå¤±',
                        description: 'login() æ–¹æ³•æœªå®šä¹‰æˆ–æ— æ³•è®¿é—®',
                        status: 'error'
                    });
                    log('ç™»å½•æ–¹æ³•ç¼ºå¤±', 'error');
                }
            } else {
                results.push({
                    icon: 'âŒ',
                    title: 'è®¤è¯ç³»ç»ŸæœªåŠ è½½',
                    description: 'è®¤è¯ç³»ç»Ÿè„šæœ¬å¯èƒ½æœªåŠ è½½æˆ–åŠ è½½å¤±è´¥',
                    status: 'error'
                });
                log('è®¤è¯ç³»ç»ŸæœªåŠ è½½', 'error');
            }

            // 4. æ£€æŸ¥å†…å®¹ç®¡ç†å™¨
            if (window.contentManager) {
                results.push({
                    icon: 'âœ…',
                    title: 'å†…å®¹ç®¡ç†å™¨å·²åŠ è½½',
                    description: 'å†…å®¹ç®¡ç†ç³»ç»ŸåŠ è½½æˆåŠŸ',
                    status: 'good'
                });
                log('å†…å®¹ç®¡ç†å™¨æ£€æŸ¥é€šè¿‡', 'success');
            } else {
                results.push({
                    icon: 'âš ï¸',
                    title: 'å†…å®¹ç®¡ç†å™¨æœªåŠ è½½',
                    description: 'å†…å®¹ç®¡ç†å™¨å¯èƒ½å½±å“æŸäº›åŠŸèƒ½',
                    status: 'warning'
                });
                log('å†…å®¹ç®¡ç†å™¨æœªåŠ è½½', 'warning');
            }

            updateStatus(results);
            log('å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        async function tryFixAuth() {
            log('å°è¯•ä¿®å¤è®¤è¯ç³»ç»Ÿ...', 'info');
            
            // 1. é‡æ–°åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            if (window.supabase && !window.supabaseClient) {
                try {
                    const { createClient } = window.supabase;
                    window.supabaseClient = createClient(
                        'https://fnnbtlfqjfgbifhhnuij.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubmJ0bGZxamZnYmlmaGhudWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzgzMzIsImV4cCI6MjA3MzQxNDMzMn0.3dayc8xJQsrr3MbWp4C30hcjpOMd0P7ro380F6iQX00'
                    );
                    log('Supabase å®¢æˆ·ç«¯é‡æ–°åˆ›å»ºæˆåŠŸ', 'success');
                } catch (error) {
                    log(`Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                }
            }

            // 2. ç­‰å¾…è®¤è¯ç³»ç»ŸåŠ è½½
            let retries = 0;
            const maxRetries = 10;
            
            const waitForAuth = () => {
                return new Promise((resolve) => {
                    const checkAuth = () => {
                        retries++;
                        if (window.authSystem) {
                            log('è®¤è¯ç³»ç»ŸåŠ è½½æˆåŠŸ', 'success');
                            resolve(true);
                        } else if (retries < maxRetries) {
                            log(`ç­‰å¾…è®¤è¯ç³»ç»ŸåŠ è½½... (${retries}/${maxRetries})`, 'info');
                            setTimeout(checkAuth, 500);
                        } else {
                            log('è®¤è¯ç³»ç»ŸåŠ è½½è¶…æ—¶', 'error');
                            resolve(false);
                        }
                    };
                    checkAuth();
                });
            };

            await waitForAuth();
            
            // 3. é‡æ–°è¿è¡Œè¯Šæ–­
            setTimeout(() => {
                runFullDiagnosis();
            }, 1000);
        }

        async function testLogin() {
            if (!window.authSystem) {
                log('æµ‹è¯•å¤±è´¥: è®¤è¯ç³»ç»ŸæœªåŠ è½½', 'error');
                alert('è®¤è¯ç³»ç»ŸæœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•ç™»å½•ï¼è¯·å…ˆå°è¯•ä¿®å¤ã€‚');
                return;
            }

            const testCredentials = {
                username: 'test@example.com',
                password: 'testpassword'
            };

            log('å¼€å§‹æµ‹è¯•ç™»å½•åŠŸèƒ½...', 'info');
            
            try {
                // è¿™åªæ˜¯æµ‹è¯•å‡½æ•°æ˜¯å¦å¯è°ƒç”¨ï¼Œä¸æ˜¯çœŸå®ç™»å½•
                log('æµ‹è¯• login() æ–¹æ³•è°ƒç”¨...', 'info');
                
                if (typeof window.authSystem.login === 'function') {
                    log('login() æ–¹æ³•å¯ä»¥æ­£å¸¸è°ƒç”¨', 'success');
                } else {
                    throw new Error('login() æ–¹æ³•ä¸å­˜åœ¨');
                }
                
                log('ç™»å½•åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿè¿™å°†é€€å‡ºå½“å‰ç™»å½•çŠ¶æ€ã€‚')) {
                log('æ¸…é™¤æœ¬åœ°æ•°æ®...', 'info');
                
                // æ¸…é™¤ localStorage
                localStorage.removeItem('linkaitiya_current_user');
                localStorage.removeItem('linkaitiya_user');
                
                // æ¸…é™¤ sessionStorage
                sessionStorage.clear();
                
                // é‡ç½®è®¤è¯çŠ¶æ€
                if (window.authSystem) {
                    window.authSystem.currentUser = null;
                }
                
                log('æœ¬åœ°æ•°æ®å·²æ¸…é™¤', 'success');
                alert('æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼Œå»ºè®®åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ï¼');
            }
        }

        async function initializeDatabase() {
            if (!window.supabaseClient) {
                log('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                alert('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆå§‹åŒ–æ•°æ®åº“ï¼');
                return;
            }

            log('å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...', 'info');
            
            try {
                // æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨
                const tables = ['users', 'vocabulary', 'grammar', 'posts', 'replies'];
                const results = [];
                
                for (const table of tables) {
                    try {
                        log(`æ£€æŸ¥è¡¨: ${table}...`, 'info');
                        const { data, error } = await window.supabaseClient
                            .from(table)
                            .select('count', { count: 'exact', head: true })
                            .limit(1);
                        
                        if (!error) {
                            log(`âœ… è¡¨ ${table} å­˜åœ¨ï¼Œè®°å½•æ•°: ${data || 0}`, 'success');
                            results.push({ table, status: 'exists', count: data || 0 });
                        } else {
                            throw error;
                        }
                    } catch (error) {
                        log(`âŒ è¡¨ ${table} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${error.message}`, 'error');
                        results.push({ table, status: 'missing', error: error.message });
                    }
                }
                
                // æ˜¾ç¤ºç»“æœ
                const existingTables = results.filter(r => r.status === 'exists');
                const missingTables = results.filter(r => r.status === 'missing');
                
                log(`æ£€æŸ¥å®Œæˆ: ${existingTables.length}/5 ä¸ªè¡¨å­˜åœ¨`, 'info');
                
                if (missingTables.length > 0) {
                    alert(`æ£€æµ‹åˆ° ${missingTables.length} ä¸ªè¡¨ç¼ºå¤±æˆ–æ— æ³•è®¿é—®\n\nç¼ºå¤±çš„è¡¨: ${missingTables.map(t => t.table).join(', ')}\n\nè¯·åœ¨ Supabase æ§åˆ¶å°ä¸­æ‰§è¡Œ supabase-database-setup.sql è„šæœ¬åˆå§‹åŒ–æ•°æ®åº“ã€‚`);
                } else {
                    alert('æ‰€æœ‰æ•°æ®åº“è¡¨éƒ½å­˜åœ¨ï¼Œæ•°æ®åº“åˆå§‹åŒ–æ­£å¸¸ï¼');
                }
                
                // å¦‚æœ users è¡¨å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
                if (existingTables.find(t => t.table === 'users')) {
                    try {
                        log('æ£€æŸ¥é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·...', 'info');
                        const { data: adminUser, error: adminError } = await window.supabaseClient
                            .from('users')
                            .select('*')
                            .eq('username', 'ç³å‡¯è’‚äºš')
                            .single();
                        
                        if (adminError && adminError.code === 'PGRST116') {
                            // ç®¡ç†å‘˜ä¸å­˜åœ¨ï¼Œæç¤ºåˆ›å»º
                            log('é»˜è®¤ç®¡ç†å‘˜ä¸å­˜åœ¨', 'warning');
                            if (confirm('æ£€æµ‹åˆ°æ•°æ®åº“ä¸­æ²¡æœ‰é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼Œæ˜¯å¦åˆ›å»ºï¼Ÿ')) {
                                // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºç®¡ç†å‘˜çš„é€»è¾‘
                                alert('è¯·é€šè¿‡æ­£å¸¸æ³¨å†Œæµç¨‹åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼Œç„¶ååœ¨æ•°æ®åº“ä¸­ä¿®æ”¹è§’è‰²ä¸º adminã€‚');
                            }
                        } else if (!adminError) {
                            log(`âœ… æ‰¾åˆ°ç®¡ç†å‘˜è´¦æˆ·: ${adminUser.username}`, 'success');
                        }
                    } catch (error) {
                        log(`æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·æ—¶å‡ºé”™: ${error.message}`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                alert(`æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(() => {
                runFullDiagnosis();
            }, 2000);
        });

        // ç«‹å³è¿è¡ŒåŸºç¡€æ£€æŸ¥
        setTimeout(() => {
            log('å¼€å§‹åŸºç¡€æ£€æŸ¥...', 'info');
            log(`Supabase CDN: ${typeof window.supabase !== 'undefined' ? 'âœ…' : 'âŒ'}`, 'info');
            log(`Supabase Client: ${!!window.supabaseClient ? 'âœ…' : 'âŒ'}`, 'info');
            log(`Auth System: ${!!window.authSystem ? 'âœ…' : 'âŒ'}`, 'info');
        }, 500);
    </script>
</body>
</html>