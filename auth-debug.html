<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证系统诊断 - 琳凯蒂亚语社区</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .status-good { border-color: #4caf50; }
        .status-warning { border-color: #ff9800; }
        .status-error { border-color: #f44336; }
        
        .btn {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 认证系统诊断工具</h1>
        <p>此工具帮助诊断登录失败问题</p>
        
        <div id="statusContainer">
            <div class="status-item status-warning">
                <strong>⏳ 正在检查...</strong><br>
                系统诊断进行中...
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="runFullDiagnosis()">🔍 完整诊断</button>
            <button class="btn" onclick="tryFixAuth()">🔧 尝试修复</button>
            <button class="btn" onclick="testLogin()">🧪 测试登录</button>
            <button class="btn" onclick="initializeDatabase()">📊 初始化数据库</button>
            <button class="btn" onclick="clearAllData()">🗑️ 清除数据</button>
        </div>

        <div class="log-container" id="logContainer">
            <div style="color: #4caf50;">[INFO] 诊断工具已启动</div>
        </div>

        <div style="margin-top: 20px;">
            <h3>📋 快速解决方案</h3>
            
            <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>🔥 最常见问题：数据库表未初始化</h4>
                <p><strong>如果显示“表不存在”错误，请按以下步骤操作：</strong></p>
                <ol>
                    <li>登录 <a href="https://supabase.com/dashboard" target="_blank" style="color: #ffd700;">🔗 Supabase 控制台</a></li>
                    <li>进入您的项目 → SQL Editor</li>
                    <li>复制 <code>supabase-database-setup.sql</code> 中的全部内容</li>
                    <li>粘贴到 SQL 编辑器并执行</li>
                    <li>返回此页面点击 “📊 初始化数据库” 验证</li>
                </ol>
            </div>
            
            <div style="background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>🚫 网络连接问题</h4>
                <p><strong>如果显示网络连接失败：</strong></p>
                <ol>
                    <li>🚫 检查防火墙是否封锁 <code>supabase.co</code></li>
                    <li>🚫 关闭广告拦截器或者浏览器扩展</li>
                    <li>🌐 尝试使用 VPN 或者更换网络</li>
                    <li>🔄 刷新页面重试</li>
                </ol>
            </div>
            
            <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <h4>✅ 基本排错步骤</h4>
                <ol>
                    <li><strong>刷新页面</strong> - 按 F5 或 Ctrl+R</li>
                    <li><strong>清除浏览器缓存</strong> - 按 Ctrl+Shift+Delete</li>
                    <li><strong>检查网络连接</strong> - 确保可以访问 Supabase</li>
                    <li><strong>禁用浏览器扩展</strong> - 临时禁用广告拦截器</li>
                    <li><strong>使用现代浏览器</strong> - Chrome, Firefox, Edge</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Supabase CDN支持 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase配置 -->
    <script src="config/supabase.js"></script>
    <!-- GitHub Pages兼容的认证和内容管理系统 -->
    <script src="github-pages-auth-system.js"></script>
    <script src="github-pages-content-manager-optimized.js"></script>

    <script>
        let diagnosticLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp} [${type.toUpperCase()}] ${message}`;
            diagnosticLogs.push(logEntry);
            
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.style.color = type === 'error' ? '#f44336' : 
                               type === 'warning' ? '#ff9800' : 
                               type === 'success' ? '#4caf50' : '#ffffff';
            logDiv.textContent = logEntry;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(items) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = items.map(item => `
                <div class="status-item status-${item.status}">
                    <strong>${item.icon} ${item.title}</strong><br>
                    ${item.description}
                </div>
            `).join('');
        }

        async function runFullDiagnosis() {
            log('开始完整诊断...', 'info');
            const results = [];

            // 1. 检查 Supabase CDN
            if (typeof window.supabase !== 'undefined') {
                results.push({
                    icon: '✅',
                    title: 'Supabase CDN 已加载',
                    description: 'Supabase JavaScript 库加载成功',
                    status: 'good'
                });
                log('Supabase CDN 检查通过', 'success');
            } else {
                results.push({
                    icon: '❌',
                    title: 'Supabase CDN 未加载',
                    description: 'Supabase JavaScript 库加载失败，请检查网络连接',
                    status: 'error'
                });
                log('Supabase CDN 加载失败', 'error');
            }

            // 2. 检查 Supabase 客户端
            if (window.supabaseClient) {
                results.push({
                    icon: '✅',
                    title: 'Supabase 客户端已创建',
                    description: 'Supabase 客户端实例创建成功',
                    status: 'good'
                });
                log('Supabase 客户端检查通过', 'success');
                
                // 测试数据库连接
                try {
                    log('开始测试数据库连接...', 'info');
                    
                    // 首先测试简单的连接
                    const { data, error } = await window.supabaseClient
                        .from('users')
                        .select('count', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (!error) {
                        results.push({
                            icon: '✅',
                            title: '数据库连接正常',
                            description: `成功连接到 Supabase 数据库，用户表记录数: ${data || 'unknown'}`,
                            status: 'good'
                        });
                        log('数据库连接测试通过', 'success');
                    } else {
                        throw error;
                    }
                } catch (error) {
                    log(`详细错误信息: ${JSON.stringify(error, null, 2)}`, 'error');
                    
                    let errorDescription = `数据库连接错误: ${error.message}`;
                    let suggestions = '';
                    
                    // 根据错误类型提供具体建议
                    if (error.message.includes('Failed to fetch')) {
                        errorDescription += ' (网络连接失败)';
                        suggestions = '建议: 1) 检查网络连接 2) 检查防火墙设置 3) 尝试使用VPN';
                    } else if (error.message.includes('Invalid API key')) {
                        errorDescription += ' (API密钥无效)';
                        suggestions = '建议: 检查 Supabase 项目配置和 API 密钥';
                    } else if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        errorDescription += ' (数据表不存在)';
                        suggestions = '建议: 检查数据库是否已正确创建表结构';
                    } else if (error.code === 'PGRST116') {
                        errorDescription += ' (表不存在或无权限访问)';
                        suggestions = '建议: 1) 运行数据库初始化脚本 2) 检查RLS策略设置';
                    }
                    
                    results.push({
                        icon: '❌',
                        title: '数据库连接失败',
                        description: `${errorDescription}<br><small style="color: #ffeb3b;">${suggestions}</small>`,
                        status: 'error'
                    });
                    log(`数据库连接错误: ${error.message}`, 'error');
                    
                    // 尝试测试基础连接
                    try {
                        log('尝试测试基础 Supabase 连接...', 'info');
                        const response = await fetch('https://fnnbtlfqjfgbifhhnuij.supabase.co/rest/v1/', {
                            method: 'GET',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubmJ0bGZxamZnYmlmaGhudWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzgzMzIsImV4cCI6MjA3MzQxNDMzMn0.3dayc8xJQsrr3MbWp4C30hcjpOMd0P7ro380F6iQX00'
                            }
                        });
                        
                        if (response.ok || response.status === 400) {
                            log('基础 HTTP 连接正常，问题可能是表结构相关', 'warning');
                            results.push({
                                icon: '⚠️',
                                title: 'HTTP连接正常，但表访问失败',
                                description: '网络连接正常，但可能需要初始化数据库表',
                                status: 'warning'
                            });
                        } else {
                            log(`HTTP连接也失败: ${response.status}`, 'error');
                        }
                    } catch (fetchError) {
                        log(`基础连接测试失败: ${fetchError.message}`, 'error');
                        results.push({
                            icon: '❌',
                            title: '网络连接完全失败',
                            description: '无法连接到 Supabase 服务器，请检查网络连接',
                            status: 'error'
                        });
                    }
                }
            } else {
                results.push({
                    icon: '❌',
                    title: 'Supabase 客户端未创建',
                    description: 'Supabase 客户端实例创建失败',
                    status: 'error'
                });
                log('Supabase 客户端未创建', 'error');
            }

            // 3. 检查认证系统
            if (window.authSystem) {
                results.push({
                    icon: '✅',
                    title: '认证系统已加载',
                    description: 'GitHub Pages 认证系统加载成功',
                    status: 'good'
                });
                log('认证系统检查通过', 'success');

                // 检查认证方法
                if (typeof window.authSystem.login === 'function') {
                    results.push({
                        icon: '✅',
                        title: '登录方法可用',
                        description: 'login() 方法已正确定义',
                        status: 'good'
                    });
                    log('登录方法检查通过', 'success');
                } else {
                    results.push({
                        icon: '❌',
                        title: '登录方法缺失',
                        description: 'login() 方法未定义或无法访问',
                        status: 'error'
                    });
                    log('登录方法缺失', 'error');
                }
            } else {
                results.push({
                    icon: '❌',
                    title: '认证系统未加载',
                    description: '认证系统脚本可能未加载或加载失败',
                    status: 'error'
                });
                log('认证系统未加载', 'error');
            }

            // 4. 检查内容管理器
            if (window.contentManager) {
                results.push({
                    icon: '✅',
                    title: '内容管理器已加载',
                    description: '内容管理系统加载成功',
                    status: 'good'
                });
                log('内容管理器检查通过', 'success');
            } else {
                results.push({
                    icon: '⚠️',
                    title: '内容管理器未加载',
                    description: '内容管理器可能影响某些功能',
                    status: 'warning'
                });
                log('内容管理器未加载', 'warning');
            }

            updateStatus(results);
            log('完整诊断完成', 'success');
        }

        async function tryFixAuth() {
            log('尝试修复认证系统...', 'info');
            
            // 1. 重新初始化 Supabase 客户端
            if (window.supabase && !window.supabaseClient) {
                try {
                    const { createClient } = window.supabase;
                    window.supabaseClient = createClient(
                        'https://fnnbtlfqjfgbifhhnuij.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubmJ0bGZxamZnYmlmaGhudWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzgzMzIsImV4cCI6MjA3MzQxNDMzMn0.3dayc8xJQsrr3MbWp4C30hcjpOMd0P7ro380F6iQX00'
                    );
                    log('Supabase 客户端重新创建成功', 'success');
                } catch (error) {
                    log(`Supabase 客户端创建失败: ${error.message}`, 'error');
                }
            }

            // 2. 等待认证系统加载
            let retries = 0;
            const maxRetries = 10;
            
            const waitForAuth = () => {
                return new Promise((resolve) => {
                    const checkAuth = () => {
                        retries++;
                        if (window.authSystem) {
                            log('认证系统加载成功', 'success');
                            resolve(true);
                        } else if (retries < maxRetries) {
                            log(`等待认证系统加载... (${retries}/${maxRetries})`, 'info');
                            setTimeout(checkAuth, 500);
                        } else {
                            log('认证系统加载超时', 'error');
                            resolve(false);
                        }
                    };
                    checkAuth();
                });
            };

            await waitForAuth();
            
            // 3. 重新运行诊断
            setTimeout(() => {
                runFullDiagnosis();
            }, 1000);
        }

        async function testLogin() {
            if (!window.authSystem) {
                log('测试失败: 认证系统未加载', 'error');
                alert('认证系统未加载，无法测试登录！请先尝试修复。');
                return;
            }

            const testCredentials = {
                username: 'test@example.com',
                password: 'testpassword'
            };

            log('开始测试登录功能...', 'info');
            
            try {
                // 这只是测试函数是否可调用，不是真实登录
                log('测试 login() 方法调用...', 'info');
                
                if (typeof window.authSystem.login === 'function') {
                    log('login() 方法可以正常调用', 'success');
                } else {
                    throw new Error('login() 方法不存在');
                }
                
                log('登录功能测试完成', 'success');
                
            } catch (error) {
                log(`登录测试失败: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('确定要清除所有本地数据吗？这将退出当前登录状态。')) {
                log('清除本地数据...', 'info');
                
                // 清除 localStorage
                localStorage.removeItem('linkaitiya_current_user');
                localStorage.removeItem('linkaitiya_user');
                
                // 清除 sessionStorage
                sessionStorage.clear();
                
                // 重置认证状态
                if (window.authSystem) {
                    window.authSystem.currentUser = null;
                }
                
                log('本地数据已清除', 'success');
                alert('本地数据已清除，建议刷新页面重新开始！');
            }
        }

        async function initializeDatabase() {
            if (!window.supabaseClient) {
                log('数据库初始化失败: Supabase 客户端未初始化', 'error');
                alert('Supabase 客户端未初始化，无法初始化数据库！');
                return;
            }

            log('开始初始化数据库...', 'info');
            
            try {
                // 检查数据库表是否存在
                const tables = ['users', 'vocabulary', 'grammar', 'posts', 'replies'];
                const results = [];
                
                for (const table of tables) {
                    try {
                        log(`检查表: ${table}...`, 'info');
                        const { data, error } = await window.supabaseClient
                            .from(table)
                            .select('count', { count: 'exact', head: true })
                            .limit(1);
                        
                        if (!error) {
                            log(`✅ 表 ${table} 存在，记录数: ${data || 0}`, 'success');
                            results.push({ table, status: 'exists', count: data || 0 });
                        } else {
                            throw error;
                        }
                    } catch (error) {
                        log(`❌ 表 ${table} 不存在或无法访问: ${error.message}`, 'error');
                        results.push({ table, status: 'missing', error: error.message });
                    }
                }
                
                // 显示结果
                const existingTables = results.filter(r => r.status === 'exists');
                const missingTables = results.filter(r => r.status === 'missing');
                
                log(`检查完成: ${existingTables.length}/5 个表存在`, 'info');
                
                if (missingTables.length > 0) {
                    alert(`检测到 ${missingTables.length} 个表缺失或无法访问\n\n缺失的表: ${missingTables.map(t => t.table).join(', ')}\n\n请在 Supabase 控制台中执行 supabase-database-setup.sql 脚本初始化数据库。`);
                } else {
                    alert('所有数据库表都存在，数据库初始化正常！');
                }
                
                // 如果 users 表存在，尝试创建默认管理员账户
                if (existingTables.find(t => t.table === 'users')) {
                    try {
                        log('检查默认管理员账户...', 'info');
                        const { data: adminUser, error: adminError } = await window.supabaseClient
                            .from('users')
                            .select('*')
                            .eq('username', '琳凯蒂亚')
                            .single();
                        
                        if (adminError && adminError.code === 'PGRST116') {
                            // 管理员不存在，提示创建
                            log('默认管理员不存在', 'warning');
                            if (confirm('检测到数据库中没有默认管理员账户，是否创建？')) {
                                // 这里可以添加创建管理员的逻辑
                                alert('请通过正常注册流程创建管理员账户，然后在数据库中修改角色为 admin。');
                            }
                        } else if (!adminError) {
                            log(`✅ 找到管理员账户: ${adminUser.username}`, 'success');
                        }
                    } catch (error) {
                        log(`检查管理员账户时出错: ${error.message}`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`数据库初始化失败: ${error.message}`, 'error');
                alert(`数据库初始化失败: ${error.message}`);
            }
        }

        // 页面加载后自动运行诊断
        window.addEventListener('load', () => {
            setTimeout(() => {
                runFullDiagnosis();
            }, 2000);
        });

        // 立即运行基础检查
        setTimeout(() => {
            log('开始基础检查...', 'info');
            log(`Supabase CDN: ${typeof window.supabase !== 'undefined' ? '✅' : '❌'}`, 'info');
            log(`Supabase Client: ${!!window.supabaseClient ? '✅' : '❌'}`, 'info');
            log(`Auth System: ${!!window.authSystem ? '✅' : '❌'}`, 'info');
        }, 500);
    </script>
</body>
</html>