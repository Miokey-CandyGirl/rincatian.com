<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages æ•°æ®è¿ç§»å·¥å…· - ç³å‡¯è’‚äºšè¯­ç¤¾åŒº</title>
    <link rel="icon" href="flag_logo.jpg" type="image/jpg">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 30px;
        }
        
        .migration-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            color: #00bcd4;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }
        
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        
        .status.info {
            background: rgba(0, 188, 212, 0.2);
            border: 1px solid #00bcd4;
            color: #00bcd4;
        }
        
        .data-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bcd4, #4caf50);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 2;
        }
        
        .step.active .step-number {
            background: #00bcd4;
        }
        
        .step.completed .step-number {
            background: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ GitHub Pages æ•°æ®è¿ç§»å·¥å…·</h1>
        
        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
            <ul>
                <li>è¿™æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®è¿ç§»å·¥å…·ï¼Œç”¨äºå°†LocalStorageæ•°æ®è¿ç§»åˆ°Supabase</li>
                <li>è¯·ç¡®ä¿æ‚¨å·²ç»åœ¨Supabaseä¸­è®¾ç½®å¥½æ•°æ®åº“è¡¨ç»“æ„</li>
                <li>è¿ç§»è¿‡ç¨‹ä¸å¯é€†ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                <li>å»ºè®®åœ¨è¿ç§»å‰å¤‡ä»½æ‚¨çš„æ•°æ®</li>
            </ul>
        </div>

        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div>æ£€æŸ¥ç¯å¢ƒ</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>æ‰«ææ•°æ®</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>æ‰§è¡Œè¿ç§»</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div>éªŒè¯ç»“æœ</div>
            </div>
        </div>

        <!-- ç¯å¢ƒæ£€æŸ¥ -->
        <div class="migration-section">
            <div class="section-title">
                ğŸ”§ ç¯å¢ƒæ£€æŸ¥
            </div>
            <div id="environmentStatus" class="status info">
                æ­£åœ¨æ£€æŸ¥ç¯å¢ƒé…ç½®...
            </div>
            <button class="btn" onclick="checkEnvironment()">é‡æ–°æ£€æŸ¥ç¯å¢ƒ</button>
        </div>

        <!-- æ•°æ®æ‰«æ -->
        <div class="migration-section">
            <div class="section-title">
                ğŸ“Š LocalStorage æ•°æ®æ‰«æ
            </div>
            <div id="scanStatus" class="status info">
                ç‚¹å‡»æŒ‰é’®å¼€å§‹æ‰«ææœ¬åœ°æ•°æ®
            </div>
            <button class="btn" onclick="scanLocalData()" id="scanBtn">æ‰«ææœ¬åœ°æ•°æ®</button>
            
            <div id="dataPreview" class="data-preview" style="display: none;">
                <!-- æ•°æ®é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æ•°æ®è¿ç§» -->
        <div class="migration-section">
            <div class="section-title">
                ğŸš€ æ•°æ®è¿ç§»
            </div>
            <div id="migrationStatus" class="status info">
                è¯·å…ˆå®Œæˆæ•°æ®æ‰«æ
            </div>
            <div class="progress-bar" style="display: none;" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <button class="btn btn-success" onclick="startMigration()" id="migrateBtn" disabled>å¼€å§‹è¿ç§»</button>
            <button class="btn btn-danger" onclick="clearLocalData()" id="clearBtn" disabled>æ¸…é™¤æœ¬åœ°æ•°æ®</button>
        </div>

        <!-- è¿ç§»ç»“æœ -->
        <div class="migration-section">
            <div class="section-title">
                âœ… è¿ç§»ç»“æœ
            </div>
            <div id="resultStatus" class="status info">
                è¿ç§»å®Œæˆåå°†æ˜¾ç¤ºç»“æœ
            </div>
            <div id="migrationDetails" style="display: none;">
                <!-- è¿ç§»è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="window.location.href='index.html'">
                ğŸ  è¿”å›é¦–é¡µ
            </button>
            <button class="btn" onclick="window.location.href='admin.html'">
                âš™ï¸ ç®¡ç†åå°
            </button>
        </div>
    </div>

    <!-- Supabase CDNæ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabaseé…ç½® -->
    <script src="config/supabase.js"></script>
    <!-- GitHub Pageså…¼å®¹çš„è®¤è¯å’Œå†…å®¹ç®¡ç†ç³»ç»Ÿ -->
    <script src="github-pages-auth-system.js"></script>
    <script src="github-pages-content-manager.js"></script>

    <script>
        // GitHub Pagesç‰ˆæœ¬çš„æ•°æ®è¿ç§»é€»è¾‘
        let localData = null;
        let migrationProgress = 0;

        // æ£€æŸ¥ç¯å¢ƒ
        async function checkEnvironment() {
            const statusEl = document.getElementById('environmentStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'æ­£åœ¨æ£€æŸ¥ç¯å¢ƒ...';

            try {
                // æ£€æŸ¥Supabaseè¿æ¥
                if (!window.supabaseClient) {
                    throw new Error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const { data, error } = await window.supabaseClient
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (error && error.code !== 'PGRST116') {
                    throw new Error(`æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`);
                }

                statusEl.className = 'status success';
                statusEl.innerHTML = `
                    âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡<br>
                    ğŸ“¡ Supabaseè¿æ¥æ­£å¸¸<br>
                    ğŸ—„ï¸ æ•°æ®åº“è¡¨å¯è®¿é—®
                `;

                updateStep(1, 'completed');
                updateStep(2, 'active');

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥<br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}
                `;
            }
        }

        // æ‰«ææœ¬åœ°æ•°æ®
        function scanLocalData() {
            const statusEl = document.getElementById('scanStatus');
            const previewEl = document.getElementById('dataPreview');
            const scanBtn = document.getElementById('scanBtn');

            statusEl.className = 'status info';
            statusEl.textContent = 'æ­£åœ¨æ‰«ææœ¬åœ°æ•°æ®...';

            try {
                // æ‰«æLocalStorage
                const vocabularyData = JSON.parse(localStorage.getItem('linkaitiya_vocabulary') || '[]');
                const grammarData = JSON.parse(localStorage.getItem('linkaitiya_grammar') || '[]');
                const userData = JSON.parse(localStorage.getItem('linkaitiya_users') || '[]');
                const phrasesData = JSON.parse(localStorage.getItem('linkaitiya_phrases') || '[]');

                localData = {
                    vocabulary: vocabularyData,
                    grammar: grammarData,
                    users: userData,
                    phrases: phrasesData
                };

                const totalItems = vocabularyData.length + grammarData.length + userData.length + phrasesData.length;

                if (totalItems === 0) {
                    statusEl.className = 'status info';
                    statusEl.textContent = 'æœªå‘ç°æœ¬åœ°æ•°æ®ï¼Œå¯èƒ½å·²ç»è¿ç§»æˆ–è€…æ˜¯æ–°å®‰è£…';
                    return;
                }

                statusEl.className = 'status success';
                statusEl.innerHTML = `
                    âœ… æ‰«æå®Œæˆï¼Œå‘ç° ${totalItems} æ¡æ•°æ®<br>
                    ğŸ“š è¯æ±‡: ${vocabularyData.length} æ¡<br>
                    ğŸ“ è¯­æ³•: ${grammarData.length} æ¡<br>
                    ğŸ‘¥ ç”¨æˆ·: ${userData.length} æ¡<br>
                    ğŸ’¬ çŸ­è¯­: ${phrasesData.length} æ¡
                `;

                // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                previewEl.innerHTML = `
                    <h4>æ•°æ®é¢„è§ˆ (å‰5æ¡)</h4>
                    <h5>è¯æ±‡æ•°æ®:</h5>
                    <pre>${JSON.stringify(vocabularyData.slice(0, 5), null, 2)}</pre>
                    <h5>è¯­æ³•æ•°æ®:</h5>
                    <pre>${JSON.stringify(grammarData.slice(0, 5), null, 2)}</pre>
                `;
                previewEl.style.display = 'block';

                // å¯ç”¨è¿ç§»æŒ‰é’®
                document.getElementById('migrateBtn').disabled = false;

                updateStep(2, 'completed');
                updateStep(3, 'active');

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `æ‰«æå¤±è´¥: ${error.message}`;
            }
        }

        // å¼€å§‹è¿ç§»
        async function startMigration() {
            if (!localData) {
                alert('è¯·å…ˆæ‰«ææœ¬åœ°æ•°æ®');
                return;
            }

            const statusEl = document.getElementById('migrationStatus');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const migrateBtn = document.getElementById('migrateBtn');

            statusEl.className = 'status info';
            statusEl.textContent = 'å¼€å§‹æ•°æ®è¿ç§»...';
            progressBar.style.display = 'block';
            migrateBtn.disabled = true;

            try {
                let completed = 0;
                const totalSteps = 4; // è¯æ±‡ã€è¯­æ³•ã€ç”¨æˆ·ã€çŸ­è¯­

                // è¿ç§»è¯æ±‡æ•°æ®
                if (localData.vocabulary.length > 0) {
                    statusEl.textContent = 'æ­£åœ¨è¿ç§»è¯æ±‡æ•°æ®...';
                    await migrateVocabulary(localData.vocabulary);
                    completed++;
                    updateProgress(completed / totalSteps * 100);
                }

                // è¿ç§»è¯­æ³•æ•°æ®
                if (localData.grammar.length > 0) {
                    statusEl.textContent = 'æ­£åœ¨è¿ç§»è¯­æ³•æ•°æ®...';
                    await migrateGrammar(localData.grammar);
                    completed++;
                    updateProgress(completed / totalSteps * 100);
                }

                // è¿ç§»ç”¨æˆ·æ•°æ®
                if (localData.users.length > 0) {
                    statusEl.textContent = 'æ­£åœ¨è¿ç§»ç”¨æˆ·æ•°æ®...';
                    await migrateUsers(localData.users);
                    completed++;
                    updateProgress(completed / totalSteps * 100);
                }

                // è¿ç§»çŸ­è¯­æ•°æ®
                if (localData.phrases.length > 0) {
                    statusEl.textContent = 'æ­£åœ¨è¿ç§»çŸ­è¯­æ•°æ®...';
                    await migratePhrases(localData.phrases);
                    completed++;
                    updateProgress(completed / totalSteps * 100);
                }

                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… æ•°æ®è¿ç§»å®Œæˆï¼';

                // å¯ç”¨æ¸…é™¤æŒ‰é’®
                document.getElementById('clearBtn').disabled = false;

                updateStep(3, 'completed');
                updateStep(4, 'active');

                // æ˜¾ç¤ºè¿ç§»ç»“æœ
                await showMigrationResults();

            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `è¿ç§»å¤±è´¥: ${error.message}`;
                migrateBtn.disabled = false;
            }
        }

        // è¿ç§»è¯æ±‡æ•°æ®
        async function migrateVocabulary(vocabularyData) {
            for (const vocab of vocabularyData) {
                const { error } = await window.supabaseClient
                    .from('vocabulary')
                    .upsert({
                        word: vocab.word,
                        pronunciation: vocab.pronunciation,
                        meaning: vocab.meaning,
                        type: vocab.type,
                        definition: vocab.definition,
                        examples: vocab.examples,
                        etymology: vocab.etymology,
                        usage: vocab.usage,
                        level: vocab.level,
                        tags: vocab.tags,
                        created_by: vocab.createdBy || 'migrated'
                    });

                if (error) {
                    console.warn('è¯æ±‡è¿ç§»è­¦å‘Š:', error);
                }
            }
        }

        // è¿ç§»è¯­æ³•æ•°æ®
        async function migrateGrammar(grammarData) {
            for (const grammar of grammarData) {
                const { error } = await window.supabaseClient
                    .from('grammar')
                    .upsert({
                        title: grammar.title,
                        category: grammar.category,
                        description: grammar.description,
                        rules: grammar.rules,
                        examples: grammar.examples,
                        exceptions: grammar.exceptions,
                        level: grammar.level,
                        order_num: grammar.order,
                        created_by: grammar.createdBy || 'migrated'
                    });

                if (error) {
                    console.warn('è¯­æ³•è¿ç§»è­¦å‘Š:', error);
                }
            }
        }

        // è¿ç§»ç”¨æˆ·æ•°æ®
        async function migrateUsers(userData) {
            for (const user of userData) {
                // æ³¨æ„ï¼šç”¨æˆ·æ•°æ®éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºæ¶‰åŠè®¤è¯
                console.log('ç”¨æˆ·æ•°æ®è¿ç§»:', user.username);
                // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å®ç°ç”¨æˆ·æ•°æ®è¿ç§»é€»è¾‘
            }
        }

        // è¿ç§»çŸ­è¯­æ•°æ®
        async function migratePhrases(phrasesData) {
            for (const phrase of phrasesData) {
                const { error } = await window.supabaseClient
                    .from('phrases')
                    .upsert({
                        linkaitiya: phrase.linkaitiya,
                        chinese: phrase.chinese,
                        pronunciation: phrase.pronunciation,
                        category: phrase.category,
                        usage: phrase.usage,
                        level: phrase.level,
                        created_by: phrase.createdBy || 'migrated'
                    });

                if (error) {
                    console.warn('çŸ­è¯­è¿ç§»è­¦å‘Š:', error);
                }
            }
        }

        // æ˜¾ç¤ºè¿ç§»ç»“æœ
        async function showMigrationResults() {
            const resultEl = document.getElementById('resultStatus');
            const detailsEl = document.getElementById('migrationDetails');

            try {
                // æŸ¥è¯¢è¿ç§»åçš„æ•°æ®ç»Ÿè®¡
                const [vocabResult, grammarResult] = await Promise.all([
                    window.supabaseClient.from('vocabulary').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.from('grammar').select('*', { count: 'exact', head: true })
                ]);

                resultEl.className = 'status success';
                resultEl.textContent = 'âœ… è¿ç§»å®Œæˆï¼Œæ•°æ®å·²æˆåŠŸä¿å­˜åˆ°Supabase';

                detailsEl.innerHTML = `
                    <h4>è¿ç§»ç»Ÿè®¡:</h4>
                    <ul>
                        <li>ğŸ“š è¯æ±‡è¡¨: ${vocabResult.count || 0} æ¡è®°å½•</li>
                        <li>ğŸ“ è¯­æ³•è¡¨: ${grammarResult.count || 0} æ¡è®°å½•</li>
                        <li>ğŸ”— æ•°æ®åº“: Supabase (äº‘ç«¯)</li>
                        <li>â° è¿ç§»æ—¶é—´: ${new Date().toLocaleString()}</li>
                    </ul>
                `;
                detailsEl.style.display = 'block';

                updateStep(4, 'completed');

            } catch (error) {
                resultEl.className = 'status error';
                resultEl.textContent = `è·å–è¿ç§»ç»“æœå¤±è´¥: ${error.message}`;
            }
        }

        // æ¸…é™¤æœ¬åœ°æ•°æ®
        function clearLocalData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æœ¬åœ°LocalStorageæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const keysToRemove = [
                'linkaitiya_vocabulary',
                'linkaitiya_grammar',
                'linkaitiya_users',
                'linkaitiya_phrases',
                'linkaitiya_current_user',
                'linkaitiya_sessions'
            ];

            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });

            alert('âœ… æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
            document.getElementById('clearBtn').disabled = true;
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percent}%`;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.addEventListener('load', function() {
            setTimeout(checkEnvironment, 1000);
        });
    </script>
</body>
</html>