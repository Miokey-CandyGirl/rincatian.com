# 琳凯蒂亚语网站技术文档

## 项目架构

### 技术栈
- 前端：HTML5, CSS3, JavaScript (ES6+)
- 数据库：Supabase (PostgreSQL)
- 部署：GitHub Pages
- CDN：jsDelivr

### 目录结构
```
├── config/
│   └── supabase.js              # Supabase 配置文件
├── assets/                      # 静态资源文件
├── *.html                       # 页面文件
├── *.js                         # JavaScript 文件
├── *.css                        # 样式文件
├── *.sql                        # 数据库脚本
└── README.md                    # 项目说明文件
```

## 核心文件详解

### 1. Supabase 配置文件
**文件路径**: `config/supabase.js`

**功能**: 
- 配置 Supabase 客户端连接
- 定义数据库表名常量
- 提供错误处理工具函数

**关键配置**:
```javascript
const supabaseUrl = 'https://fnnbtlfqjfgbifhhnuij.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubmJ0bGZxamZnYmlmaGhudWlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzgzMzIsImV4cCI6MjA3MzQxNDMzMn0.3dayc8xJQsrr3MbWp4C30hcjpOMd0P7ro380F6iQX00'
```

### 2. 认证系统
**文件路径**: `github-pages-auth-system.js`

**功能**:
- 用户注册、登录、登出
- 会话管理
- 权限检查
- 用户角色管理

**主要方法**:
- `register(userData)` - 用户注册
- `login(credentials)` - 用户登录
- `logout()` - 用户登出
- `hasPermission(permission)` - 权限检查
- `isAdmin()` - 管理员检查

### 3. 内容管理系统
**文件路径**: `github-pages-content-manager-optimized.js`

**功能**:
- 词汇管理
- 语法管理
- 数据查询优化
- 缓存机制

**优化特性**:
- 5分钟内存缓存
- 防重复请求机制
- 分页查询优化
- 预加载机制

### 4. 主脚本文件
**文件路径**: `script.js`

**功能**:
- 页面交互逻辑
- 认证系统集成
- UI 更新
- 事件处理

**新增调试功能**:
- `checkAuthSystemStatus()` - 检查认证系统状态
- `debugInitAuth()` - 手动初始化认证系统
- `debugRefreshAuth()` - 手动刷新认证状态

## 数据库设计

### 表结构

#### users 表
```sql
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    auth_id UUID UNIQUE,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    avatar VARCHAR(10),
    role VARCHAR(20) DEFAULT 'user',
    rank VARCHAR(50) DEFAULT '见习光线使者',
    permissions TEXT[],
    status VARCHAR(20) DEFAULT 'active',
    profile JSONB,
    join_date TIMESTAMPTZ DEFAULT NOW(),
    last_login TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### vocabulary 表
```sql
CREATE TABLE vocabulary (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    word VARCHAR(100) NOT NULL,
    pronunciation VARCHAR(200),
    meaning TEXT NOT NULL,
    type VARCHAR(50),
    definition TEXT,
    examples TEXT[],
    etymology TEXT,
    usage TEXT,
    level VARCHAR(20) DEFAULT 'basic',
    tags TEXT[],
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### grammar 表
```sql
CREATE TABLE grammar (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    category VARCHAR(100),
    description TEXT NOT NULL,
    rules TEXT[],
    examples TEXT[],
    exceptions TEXT[],
    level VARCHAR(20) DEFAULT 'beginner',
    order_num INTEGER DEFAULT 0,
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 性能优化方案

### 1. 前端缓存系统
**实现文件**: `github-pages-content-manager-optimized.js`

**核心代码**:
```javascript
const Cache = {
    data: new Map(),
    timestamps: new Map(),
    TTL: 5 * 60 * 1000, // 5分钟缓存
    
    set(key, value) {
        this.data.set(key, value);
        this.timestamps.set(key, Date.now());
    },
    
    get(key) {
        const timestamp = this.timestamps.get(key);
        if (!timestamp || Date.now() - timestamp > this.TTL) {
            this.data.delete(key);
            this.timestamps.delete(key);
            return null;
        }
        return this.data.get(key);
    }
};
```

### 2. 数据库索引优化
**实现文件**: `database-performance-optimization.sql`

**关键索引**:
```sql
-- 词汇表索引
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vocabulary_word_gin ON vocabulary USING GIN (to_tsvector('english', word));
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vocabulary_meaning_gin ON vocabulary USING GIN (to_tsvector('chinese', meaning));
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vocabulary_level ON vocabulary(level);

-- 语法表索引
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_grammar_title_gin ON grammar USING GIN (to_tsvector('chinese', title));
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_grammar_description_gin ON grammar USING GIN (to_tsvector('chinese', description));
```

### 3. 查询优化视图
```sql
-- 词汇摘要视图
CREATE OR REPLACE VIEW vocabulary_summary AS
SELECT 
    id,
    word,
    pronunciation,
    meaning,
    type,
    level,
    created_at
FROM vocabulary
ORDER BY created_at DESC;
```

## 部署和维护

### GitHub Pages 部署步骤
1. 确保所有 HTML 文件正确引用脚本:
   ```html
   <!-- Supabase CDN支持 -->
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   <!-- Supabase配置 -->
   <script src="config/supabase.js"></script>
   <!-- GitHub Pages兼容的认证和内容管理系统 -->
   <script src="github-pages-auth-system.js"></script>
   <script src="github-pages-content-manager-optimized.js"></script>
   ```

2. 推送代码到 GitHub 仓库
3. 在 GitHub 仓库设置中启用 Pages 功能

### 数据库初始化
1. 登录 Supabase 控制台
2. 进入项目 → SQL Editor
3. 依次执行以下脚本:
   - `supabase-database-setup.sql` - 创建表结构和基础数据
   - `database-performance-optimization.sql` - 创建索引和优化视图

### 监控和维护
1. 定期检查 `performance-monitor.html` 页面的性能指标
2. 监控数据库使用情况（当前已使用 0.026GB）
3. 根据访问量增长情况调整优化策略

## 故障排除指南

### 登录失败问题
**错误信息**: `Cannot read properties of undefined (reading 'login')`

**解决方案**:
1. 使用 `auth-debug.html` 诊断工具检查问题
2. 确保认证系统正确加载
3. 检查网络连接和 Supabase 配置
4. 验证数据库表已初始化

### 数据加载缓慢
**解决方案**:
1. 检查数据库索引是否创建
2. 验证缓存系统是否正常工作
3. 使用性能监控页面分析瓶颈
4. 根据监控数据调整优化策略

### 数据库连接失败
**解决方案**:
1. 检查 Supabase URL 和 API 密钥
2. 验证网络连接
3. 检查防火墙设置
4. 确认 Supabase 服务状态

## 安全性考虑

### 数据安全
- 使用 Supabase 提供的行级安全 (RLS) 策略
- 敏感信息通过 Supabase Auth 管理
- 数据传输使用 HTTPS 加密

### 访问控制
- 基于角色的权限管理 (RBAC)
- 管理员用户特殊权限控制
- 用户会话管理和超时机制

## 未来扩展建议

### 功能扩展
1. 添加 AI 翻译功能
2. 实现语音识别和发音练习
3. 增加学习进度跟踪和统计
4. 开发移动端应用

### 性能优化
1. 实施 CDN 加速
2. 添加更多缓存层
3. 优化数据库查询计划
4. 实现数据分片和负载均衡

### 用户体验
1. 增加个性化推荐
2. 实现社交功能（好友、关注等）
3. 添加成就系统和排行榜
4. 支持多语言界面

---
*文档更新时间: 2025-09-15*
*维护团队: 华田中央大学田语学院*